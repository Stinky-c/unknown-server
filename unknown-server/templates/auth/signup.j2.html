{% extends "base.j2.html" %}
{% block head%}
<script src="/assets/js/zxcvbn.js"></script>

{% endblock head%}
{% block inner_html %}
<main class="card" role="main">
  <!-- auth-area is the element we hx-swap on submit -->
  <div id="auth-area">
    <h1>Sign in</h1>
    <p class="lead">Hello — Please enter details to create an account.</p>

    <!--
      Form behavior:
      - hx-post sends form via AJAX to /login
      - hx-swap="outerHTML" replaces #auth-area entirely with server response fragment
      - hx-headers picks up a CSRF token meta tag (replace on server-render)
      - hx-indicator shows a small loading indicator while request is in-flight
    -->
    <form id="login-form"
          hx-post="/auth/signup"
          hx-swap="outerHTML"
          hx-indicator="#auth-indicator"
          method="post"
          autocomplete="on">
      <div id="form-errors" aria-live="polite"></div>

      <div>
        <label for="username">Username</label>
        <input id="username" name="username" type="text" placeholder="john.doe" required/>
      </div>

      <div>
        <label for="email">Email</label>
        <input id="email" name="email" type="email" placeholder="john.doe@example.com" required/>
      </div>

      <div>
        <label for="password">Password</label>
        <input id="password" name="password" type="password" required
               minlength="6"/>
      </div>

      <div>
        <label for="confirmpassword">Confirm Password</label>
        <input id="confirmpassword" name="confirm_password" type="password" required
               minlength="6"/>
      </div>

      <div class="pw-meter-wrap" aria-hidden="false">
        <div class="pw-meter" aria-hidden="true">
          <div class="pw-meter-bar" id="pw-meter-bar" style="width:0%"></div>
        </div>
        <div id="pw-meter-text" class="pw-meter-text" aria-live="polite"></div>
        <div id="pw-feedback" class="pw-feedback" aria-live="polite"></div>
      </div>

      <div class="row controls" style="margin-top:0.25rem;">
        <label class="remember">
          <input type="checkbox" name="remember" value="1"/>
          Remember me
        </label>

        <div style="display:flex; align-items:center;">
          <div id="auth-indicator">Processing…</div>
          <button type="submit" class="btn">Sign up</button>
        </div>
      </div>

      <div style="margin-top:0.75rem; text-align:center;">
        <a class="muted-link" href="/forgot">Forgot password?</a>
      </div>
    </form>
    <hr style="margin:1rem 0; border:none; border-top:1px solid #f0f2f4"/>
    <p style="text-align:center; font-size:0.9rem; color:var(--muted); margin:0;">Or <a
        href="/auth/login" class="muted-link">sign in</a></p>
  </div>
</main>

{% endblock %}

{% block script %}
<script>
  // Wait until DOM is ready and zxcvbn has been loaded (zxcvbn script has defer)
  (function () {
    var password = document.getElementById('password');
    var meterBar = document.getElementById('pw-meter-bar');
    var meterText = document.getElementById('pw-meter-text');
    var feedbackEl = document.getElementById('pw-feedback');

    // mapping of score to label and color
    var scoreMap = [
      {label: 'Very weak', color: '#ef4444'}, // 0
      {label: 'Weak', color: '#f97316'},      // 1
      {label: 'Fair', color: '#f59e0b'},      // 2
      {label: 'Good', color: '#10b981'},      // 3
      {label: 'Strong', color: '#064e3b'}     // 4
    ];

    function updateMeter(passwordValue) {
      if (!passwordValue) {
        // reset
        meterBar.style.width = '0%';
        meterBar.style.background = 'transparent';
        meterText.textContent = '';
        feedbackEl.textContent = '';
        return;
      }

      if (typeof zxcvbn !== 'function') {
        // zxcvbn not available, fallback to length heuristic
        var fallbackScore = Math.min(4, Math.floor(passwordValue.length / 4));
        applyScore(fallbackScore, {warning: '', suggestions: []});
        return;
      }

      var result = zxcvbn(passwordValue);
      applyScore(result.score, result.feedback || {});
    }

    function applyScore(score, feedback) {
      var pct = (score / 4) * 100;
      var m = scoreMap[score] || scoreMap[0];

      meterBar.style.width = pct + '%';
      meterBar.style.background = m.color;
      meterBar.style.boxShadow = '0 6px 18px rgba(2,6,23,0.08) inset';

      meterText.textContent = m.label + (pct < 100 ? ' (' + Math.round(pct) + '%)' : '');
      // Build feedback text: show warning first then suggestions (if any)
      var pieces = [];
      if (feedback.warning) {
        pieces.push(feedback.warning);
      }
      if (feedback.suggestions && feedback.suggestions.length) {
        pieces.push(
            feedback.suggestions.join(' '));
      }
      feedbackEl.textContent = pieces.join(' ');
    }

    if (password) {
      password.addEventListener('input', function (e) {
        updateMeter(e.target.value);
      });

      // in case the page is server-rendered with a value already populated
      document.addEventListener('DOMContentLoaded', function () {
        updateMeter(password.value || '');
      });
    }
  })();

  // lightweight enhancement: focus first invalid input returned from server
  document.body.addEventListener('htmx:afterRequest', function (evt) {
    var container = evt.detail.target;
    var invalid = container && container.querySelector('.invalid');
    if (invalid) {
      invalid.focus();
    }
  });
</script>
{% endblock %}
